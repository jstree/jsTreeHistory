<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="menu">
	<typeAlias alias="MenuComprehensiveTree" type="standard.mvc.component.business.menu.vo.MenuComprehensiveTree"/>

	<select id="menu.getChildNode" parameterClass="MenuComprehensiveTree" resultClass="MenuComprehensiveTree">
		SELECT A.c_id
		     , A.c_parentid
		     , A.c_position
		     , A.c_left
		     , A.c_right
		     , A.c_level
		     , A.c_title
		     , A.c_type
		     , A.url
		     , ( SELECT CASE
		                    WHEN COUNT(*) &gt; 0 THEN 'InChild'
           		 			ELSE 'NoChild'
           		 		END AS YesNo
         		   FROM T_MenuComprehensiveTree B
       			  WHERE B.c_parentid = A.c_id
     		   ) AS childcount
		  FROM T_MenuComprehensiveTree A
		 WHERE A.c_parentid = #c_id# 
	  ORDER BY A.c_position ASC
	</select>


	<select id="menu.getChildNodeByLeftRight" parameterClass="MenuComprehensiveTree" resultClass="MenuComprehensiveTree">
		SELECT c_id
		     , c_parentid
		     , c_position
		     , c_left
		     , c_right
		     , c_level
		     , c_title
		     , c_type
		     , url
		  FROM T_MenuComprehensiveTree 
		 WHERE c_left &gt;= #c_left# 
		   AND c_right &lt;= #c_right# 
	  ORDER BY c_left ASC
	</select>


	<select id="menu.searchNodeByString" parameterClass="MenuComprehensiveTree" resultClass="MenuComprehensiveTree">
		/* searchNodeByString */
		SELECT c_left
		     , c_right
		  FROM T_MenuComprehensiveTree 
		 WHERE C_TITLE LIKE '%'||#searchStr#||'%' 
	</select>


	<select id="menu.searchNodeByPosition" parameterClass="java.util.List" resultClass="String">
		/* searchNodeByPosition */
        SELECT DISTINCT C_ID
          FROM T_MenuComprehensiveTree
         WHERE 1=1
        <iterate prepend="AND" open="(" close=")" conjunction="OR">
            ( C_LEFT &lt; #[].c_left# AND C_RIGHT &gt; #[].c_right# )
        </iterate>
	</select>


	<update id="menu.alterNode" parameterClass="MenuComprehensiveTree">
		UPDATE T_MenuComprehensiveTree 
		   SET c_type = #c_type#
		     , c_title = #c_title# 
		 WHERE c_id = #c_id#
	</update>


	<select id="menu.getNode" parameterClass="MenuComprehensiveTree" resultClass="MenuComprehensiveTree">
        SELECT c_id
             , c_parentid
             , c_position
             , c_left
             , c_right
             , c_level
             , c_title
             , c_type
             , url
          FROM T_MenuComprehensiveTree 
         WHERE c_id = #c_id#
    </select>


	<select id="menu.getNodeByRef" parameterClass="MenuComprehensiveTree" resultClass="MenuComprehensiveTree">
        SELECT c_id
             , c_parentid
             , c_position
             , c_left
             , c_right
             , c_level
             , c_title
             , c_type
             , url
          FROM T_MenuComprehensiveTree 
         WHERE c_id = #ref#
    </select>


	<delete id="menu.removeNode" parameterClass="MenuComprehensiveTree">
		/* removeNode */
       	DELETE FROM T_MenuComprehensiveTree 
       	      WHERE C_LEFT  &gt;= #c_left# 
       	        AND C_RIGHT &lt;= #c_right#
	</delete>
	
	
	<update id="menu.removedAfterLeftFix" parameterClass="MenuComprehensiveTree">
		/* removedAfterLeftFix */
       	UPDATE T_MenuComprehensiveTree 
  		   SET C_LEFT = C_LEFT - #spaceOfTargetNode# 
   	 	 WHERE C_LEFT &gt; #c_right#
	</update>
	
	
	<update id="menu.removedAfterRightFix" parameterClass="MenuComprehensiveTree">
		/* removedAfterRightFix */
		UPDATE T_MenuComprehensiveTree 
		   SET C_RIGHT = C_RIGHT - #spaceOfTargetNode# 
		 WHERE C_RIGHT &gt; #c_left#
	</update>
	
	
	<update id="menu.removedAfterPositionFix" parameterClass="MenuComprehensiveTree">
		/* removedAfterPositionFix */
     	UPDATE T_MenuComprehensiveTree 
     	   SET C_POSITION = C_POSITION - 1 
     	 WHERE C_PARENTID = #c_parentid# 
     	   AND C_POSITION &gt; #c_position#
	</update>


	<select id="menu.analyzeRootNode" resultClass="MenuComprehensiveTree">
		/* searchNodeByString */
	    SELECT C_LEFT 
		  FROM T_MenuComprehensiveTree 
		 WHERE C_PARENTID = 0
    </select>

	<!-- 같은 부모를 가진 자식들 중 내 뒤에 있는 놈들의 포지션을 하나씩 당김. -->
	<update id="menu.cutMyselfPositionFix" parameterClass="MenuComprehensiveTree">
       	UPDATE T_MenuComprehensiveTree 
       	   SET c_position = c_position - 1 
       	 WHERE c_parentid = #c_parentid# 
           AND c_position &gt; #c_position#
    </update>


	<update id="menu.cutMyselfLeftFix" parameterClass="MenuComprehensiveTree">
       	UPDATE T_MenuComprehensiveTree 
       	   SET c_left = c_left - #spaceOfTargetNode# 
         WHERE c_left &gt; #c_right#
    </update>
    
    
	<update id="menu.cutMyselfRightFix" parameterClass="MenuComprehensiveTree">
       	UPDATE T_MenuComprehensiveTree 
       	   SET c_right = c_right - #spaceOfTargetNode# 
       	 WHERE c_right &gt; #c_left#
		<iterate prepend="AND C_ID NOT IN" property="c_idsByChildNodeFromNodeById" open="(" close=")" conjunction=",">
		       #c_idsByChildNodeFromNodeById[]#
		</iterate>
	</update>


	<update id="menu.stretchPositionForMyself" parameterClass="MenuComprehensiveTree">
        UPDATE T_MenuComprehensiveTree
           SET c_position = c_position + 1
         WHERE c_parentid = #ref# AND c_position &gt;= #c_position#
		<isEqual property="copy" compareValue="0">
           AND c_id NOT IN
			<isEmpty property="c_idsByChildNodeFromNodeById">
						   (-1)
			</isEmpty>
			<isNotEmpty property="c_idsByChildNodeFromNodeById">
				<iterate property="c_idsByChildNodeFromNodeById" open="(" close=")" conjunction=",">
		                   #c_idsByChildNodeFromNodeById[]#
				</iterate>
			</isNotEmpty>
		</isEqual>
	</update>


	<update id="menu.stretchLeftForMyselfFromJstree" parameterClass="MenuComprehensiveTree">
       	UPDATE T_MenuComprehensiveTree 
       	   SET c_left = c_left + #spaceOfTargetNode# 
       	 WHERE c_left &gt;= #rightPositionFromNodeByRef#
		<isEqual property="copyBooleanValue" compareValue="false">
			<isNotEmpty property="c_idsByChildNodeFromNodeById">
				<iterate prepend="AND c_id NOT IN" property="c_idsByChildNodeFromNodeById" open="(" close=")" conjunction=",">
					#c_idsByChildNodeFromNodeById[]#
				</iterate>
			</isNotEmpty>
		</isEqual>
	</update>


	<update id="menu.stretchRightForMyselfFromJstree" parameterClass="MenuComprehensiveTree">
        UPDATE T_MenuComprehensiveTree 
           SET c_right = c_right + #spaceOfTargetNode# 
         WHERE c_right &gt;= #rightPositionFromNodeByRef#
		<isEqual property="copyBooleanValue" compareValue="false">
			<isNotEmpty property="c_idsByChildNodeFromNodeById">
				<iterate prepend="AND c_id NOT IN" property="c_idsByChildNodeFromNodeById" open="(" close=")" conjunction=",">
			   #c_idsByChildNodeFromNodeById[]#
				</iterate>
			</isNotEmpty>
		</isEqual>
	</update>


	<insert id="menu.pasteMyselfFromJstree" parameterClass="MenuComprehensiveTree">
		/* pasteMyselfFromJstree */
        INSERT INTO T_MenuComprehensiveTree ( C_ID, C_PARENTID, C_POSITION, C_LEFT, C_RIGHT, C_LEVEL, C_TITLE, C_TYPE ) 
    	SELECT S_MenuComprehensiveTree.NEXTVAL AS C_ID
    	     , A.*
       	  FROM (
		        SELECT #ref#
		             , C_POSITION
		             , C_LEFT  - #idifLeft#  AS C_LEFT
		             , C_RIGHT - #idifRight# AS C_RIGHT
		             , C_LEVEL - #ldif#      AS C_LEVEL
		             , C_TITLE
		             , C_TYPE 
		          FROM T_MenuComprehensiveTree 
	    <iterate prepend="WHERE C_ID IN" property="c_idsByChildNodeFromNodeById" open="(" close=")" conjunction=",">
		               #c_idsByChildNodeFromNodeById[]#
		</iterate>
		      ORDER BY C_LEVEL DESC
			   ) A
		<selectKey resultClass="java.lang.Integer">
			/* pasteMyselfFromJstree SEQ */
            SELECT S_MenuComprehensiveTree.CURRVAL AS SEQ 
              FROM DUAL
        </selectKey>
	</insert>


	<update id="menu.enterMyselfFixPosition" parameterClass="MenuComprehensiveTree">
		/* enterMyselfFixPosition */
        UPDATE T_MenuComprehensiveTree 
           SET C_PARENTID = #ref#
             , C_POSITION = #c_position# 
         WHERE C_ID = #c_id#
    </update>
    
    
	<update id="menu.enterMyselfFixLeftRight" parameterClass="MenuComprehensiveTree">
		/* enterMyselfFixLeftRight */
        UPDATE T_MenuComprehensiveTree 
           SET C_LEFT  = C_LEFT  - (#idif#)
             , C_RIGHT = C_RIGHT - (#idif#)
             , C_LEVEL = C_LEVEL - (#ldif#)
		<iterate prepend="WHERE C_ID IN" property="c_idsByChildNodeFromNodeById" open="(" close=")" conjunction=",">
			   #c_idsByChildNodeFromNodeById[]#
		</iterate>
	</update>


	<insert id="menu.addMyselfFromJstree" parameterClass="MenuComprehensiveTree">
        INSERT INTO T_MenuComprehensiveTree (c_id, c_parentid, c_position, c_left, c_right, c_level, url)
        VALUES (S_MenuComprehensiveTree.NEXTVAL, #c_parentid#, #c_position#, #c_left#, #c_right#, #c_level#, #url#)
        <selectKey resultClass="java.lang.Integer">
            SELECT S_MenuComprehensiveTree.CURRVAL AS seq 
            FROM DUAL
        </selectKey>
	</insert>


	<update id="menu.alterNodeType" parameterClass="MenuComprehensiveTree">
		/* alterNodeType */
		UPDATE T_MenuComprehensiveTree 
		   SET C_TYPE = #c_type#
		 WHERE C_ID = #c_id#
	</update>


	<update id="menu.fixCopyIF" parameterClass="MenuComprehensiveTree">
        UPDATE T_MenuComprehensiveTree 
           SET c_position = #fixCopyPosition# 
         WHERE c_id = #fixCopyId#
	</update>


	<update id="menu.fixCopy" parameterClass="MenuComprehensiveTree">
		UPDATE T_MenuComprehensiveTree 
		   SET c_parentid = #fixCopyId# 
		 WHERE c_id = #c_id#
	</update>
</sqlMap>